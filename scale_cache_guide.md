# 📏 比例尺快取系統使用指南

## 📖 功能簡介

比例尺快取系統能夠自動儲存已計算的比例尺資料，避免每次執行主程式時重複計算，大幅提升程式執行效率。

## 🚀 主要功能

### 1. **自動快取管理**
- 首次執行時計算所有比例尺並儲存快取
- 後續執行只處理新增或變更的影片
- 自動檢測比例尺圖片目錄的變更

### 2. **智慧快取驗證**
- 基於目錄內容雜湊值檢查快取有效性
- 自動識別新增的影片檔案
- 檢測比例尺圖片的修改時間變更

### 3. **快取管理工具**
- 查看快取狀態和統計資訊
- 手動清除或重建快取
- 管理特定影片的快取資料

## 📁 相關檔案

```
src/
├── scale_config.py          # 快取配置檔案 (自動生成)
├── scale_cache_utils.py     # 快取管理工具函數
├── scale_setup.py           # 互動式快取管理工具
└── lift_travel_detection.py # 主程式 (已整合快取機制)
```

## 🔄 工作流程

### **首次執行**
```
📏 載入比例尺快取...
🔄 快取無效或不存在，需要重新計算所有比例尺
🔄 處理比例尺圖片: 21-0.png (影片: 21.mp4)
  ✅ 垂直距離: 42.33 像素
📊 21.mp4: 平均比例尺 42.3300 像素
✅ 比例尺快取已更新: src/scale_config.py
📊 快取統計: 18 個影片
```

### **後續執行**
```
📏 載入比例尺快取...
📋 快取有效，發現 0 個新影片需要計算比例尺

📊 比例尺快取狀態:
✅ 已快取影片數量: 18
  📹 21.mp4: 42.33 像素
  📹 22.mp4: 41.87 像素
  📹 28.mp4: 43.12 像素
  ...
```

## 🛠️ 快取管理工具

### **啟動管理工具**
```bash
python src/scale_setup.py
```

### **功能選單**
```
📏 比例尺快取管理工具
========================================

選擇操作:
  [1] 顯示快取資訊
  [2] 清除所有快取  
  [3] 重建快取
  [4] 查看特定影片
  [5] 移除特定影片快取
  [q] 退出
```

### **1. 顯示快取資訊**
```
📊 比例尺快取資訊:
📅 最後更新: 2024-01-15T10:30:45.123456
📁 目錄雜湊: 1a2b3c4d5e6f7890...
🆕 上次處理: 3 個影片

📊 比例尺快取狀態:
✅ 已快取影片數量: 18
  📹 21.mp4: 42.33 像素
  📹 22.mp4: 41.87 像素
  ...
```

### **2. 清除所有快取**
- 移除所有快取資料
- 下次執行主程式會重新計算所有比例尺

### **3. 重建快取**
- 清除現有快取並標記需要重建
- 適用於比例尺圖片大幅變更的情況

### **4. 查看特定影片**
```
請輸入影片檔名 (可省略 .mp4): 21
📹 21.mp4: 42.330000 像素
```

### **5. 移除特定影片快取**
```
請輸入要移除的影片檔名: 21
🗑️  移除影片快取: 21.mp4 (原值: 42.330000)
確定要移除嗎？ [y/N]: y
✅ 已移除 21.mp4 的快取
```

## 📊 快取配置檔案格式

### **`src/scale_config.py`**
```python
# 比例尺快取配置檔案
# 格式：'影片檔名': 平均距離像素值
# 此檔案由程式自動產生和更新，避免重複計算比例尺

scale_config = {
    '21.mp4': 42.330000,
    '22.mp4': 41.870000,
    '23.mp4': 43.120000,
    '28.mp4': 44.560000,
    '29.mp4': 41.230000,
    '30.mp4': 42.890000,
    '31-1.mp4': 43.450000,
    '37.mp4': 42.110000,
    '40.mp4': 43.780000,
    '42.mp4': 42.670000,
}

# 快取版本號，用於檢查快取是否需要更新
CACHE_VERSION = "1.0"

# 快取資訊
CACHE_INFO = {
    'last_updated': '2024-01-15T10:30:45.123456',
    'total_videos': 10,
    'directory_hash': '1a2b3c4d5e6f7890abcdef1234567890',
    'newly_processed': 3
}
```

## ⚡ 效能提升

### **時間對比**
- **首次執行**：~30-60 秒 (計算所有比例尺)
- **後續執行**：~2-5 秒 (僅載入快取)
- **新增影片**：僅計算新影片的比例尺

### **快取觸發條件**
1. **首次執行** → 建立完整快取
2. **新增影片** → 僅計算新影片
3. **圖片修改** → 重新計算相關影片
4. **目錄變更** → 重建所有快取

## 🔧 進階功能

### **手動觸發重新計算**
```bash
# 方法 1: 使用管理工具
python src/scale_setup.py
# 選擇 [3] 重建快取

# 方法 2: 直接刪除快取檔案
rm src/scale_config.py
python src/lift_travel_detection.py
```

### **備份快取配置**
```bash
# 備份重要的比例尺配置
cp src/scale_config.py scale_config_backup.py
```

### **快取失效情況**
- 比例尺圖片目錄內容變更
- 快取檔案損壞或格式錯誤
- 手動清除快取

## 📝 注意事項

1. **自動管理**：快取由程式自動管理，通常不需手動干預
2. **檔案安全**：`scale_config.py` 是自動生成的，可安全刪除重建
3. **版本相容**：不同版本的快取格式可能不相容
4. **備份建議**：重要專案建議備份 `scale_config.py`
5. **效能最佳化**：大量影片時快取效果最為顯著

## 🎯 使用建議

### **日常使用**
- 正常執行主程式，快取會自動管理
- 新增影片時會自動計算並加入快取

### **問題排除**
- 如果比例尺結果異常，可重建快取
- 如果程式執行緩慢，檢查快取是否生效

### **專案遷移**
- 複製 `src/scale_config.py` 到新環境
- 確保比例尺圖片路徑結構一致

比例尺快取系統將顯著提升您的工作效率！🎉
