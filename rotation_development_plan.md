# 🔄 影片旋轉校正功能開發文檔

## 📖 功能概述

開發一套影片旋轉校正系統，用於校正攝影機角度偏差導致的運動偵測誤判問題。系統包含互動式設定工具、配置管理和主程式整合。

## 🎯 開發目標

### 主要功能
1. **互動式旋轉設定工具** (`rotation_setup.py`)
2. **旋轉配置檔案** (`rotation_config.py`) 
3. **主程式整合修改** (修改 `lift_travel_detection.py`)
4. **視覺化追溯功能** (產生預覽圖片)
5. **比例尺同步旋轉** (確保校正精度)

## 📁 檔案結構

```
src/
├── rotation_setup.py          # 互動式旋轉設定工具
├── rotation_config.py         # 旋轉配置檔案
└── lift_travel_detection.py   # 主程式 (需修改)

lifts/
└── rotations/                 # 旋轉預覽圖片存放目錄
    ├── rotation_1.mp4.png
    ├── rotation_2.mp4.png
    └── ...
```

## 🔧 詳細功能規格

### 1. 互動式旋轉設定工具 (`rotation_setup.py`)

#### 工作流程：
1. **檢查環境** - 確認必要目錄存在
2. **循環設定** - 重複以下步驟直到使用者結束：
   - 詢問影片檔名
   - **角度設定與預覽循環**：
     - 詢問旋轉角度（逆時針為正值）
     - 生成並顯示預覽視窗
     - 詢問是否滿意效果
     - 如不滿意，可選擇取消或重新輸入角度
     - 重複直到使用者確認滿意
   - 儲存最終確認的設定
3. **產生配置** - 將所有設定寫入 `rotation_config.py`
4. **產生預覽** - 儲存旋轉預覽圖片至 `lifts/rotations/`

#### 互動介面：
```
請輸入要旋轉的影片檔名 (直接按 Enter 結束): 1.mp4
請輸入逆時針旋轉角度 (度): 15
[顯示預覽視窗 - 2560x720 並排顯示]

預覽效果是否滿意？
  [y] 確認使用此角度
  [r] 重新輸入角度
  [c] 取消此影片設定
請選擇 (y/r/c): r

請輸入逆時針旋轉角度 (度): 12
[顯示預覽視窗 - 2560x720 並排顯示]

預覽效果是否滿意？
  [y] 確認使用此角度
  [r] 重新輸入角度
  [c] 取消此影片設定
請選擇 (y/r/c): y
已設定 1.mp4 旋轉 12 度

請輸入要旋轉的影片檔名 (直接按 Enter 結束): 
設定完成！已產生 rotation_config.py
```

#### 預覽視窗規格：
- **尺寸計算**：寬度 = 原影片寬度 × 2，高度 = 原影片高度
- **內容**：從 `config.py` 指定的時間範圍內隨機選取2幀
- **顯示**：左右並排，**左側為第一幀旋轉後影像，右側為第二幀旋轉後影像**
- **標題**：顯示檔名和旋轉角度資訊

### 2. 旋轉配置檔案 (`rotation_config.py`)

#### 檔案格式：
```python
# 影片旋轉配置檔案
# 格式：'影片檔名': 旋轉角度 (逆時針為正值)

rotation_config = {
    '1.mp4': 15,
    '5-2.mp4': -10,
    '12.mp4': 20,
    # 其他需要旋轉的影片...
}
```

### 3. 互動式角度調整功能

#### 預覽確認流程：
1. **生成預覽** - 顯示旋轉後的雙幀並排預覽
2. **效果評估** - 使用者檢視旋轉後的影像效果
3. **選擇操作**：
   - **[y] 確認** - 接受當前角度設定
   - **[r] 重新輸入** - 修改角度並重新預覽
   - **[c] 取消** - 跳過此影片的旋轉設定
4. **循環調整** - 重複步驟1-3直到使用者滿意

#### 使用者體驗設計：
- **即時預覽**：每次輸入角度後立即顯示效果
- **靈活調整**：支援多次修正角度直到滿意
- **快速取消**：可隨時跳過不需要的影片
- **視覺回饋**：清楚的選項說明和操作提示

### 4. 影像旋轉處理函數

#### 核心功能：
- **剛性旋轉**：使用 OpenCV 的 `getRotationMatrix2D` 和 `warpAffine`
- **禁止縮放**：旋轉變換矩陣的縮放因子固定為 1.0
- **尺寸維持**：旋轉後裁切回原始尺寸
- **黑色填充**：空白區域使用黑色 (0, 0, 0) 填滿，**不進行縮放填滿**

#### 函數簽名：
```python
def rotate_frame(frame, angle_degrees):
    """
    剛性旋轉影像幀 (不進行縮放)
    
    Args:
        frame: 輸入影像
        angle_degrees: 旋轉角度 (逆時針為正值)
    
    Returns:
        rotated_frame: 旋轉後的影像 (維持原始尺寸，空白處黑色填充)
    """
```

#### 旋轉實作細節：
```python
# 取得影像中心點
center = (frame.shape[1] // 2, frame.shape[0] // 2)

# 建立旋轉矩陣 (縮放因子固定為 1.0)
rotation_matrix = cv2.getRotationMatrix2D(center, angle_degrees, 1.0)

# 執行剛性旋轉變換
rotated_frame = cv2.warpAffine(
    frame, 
    rotation_matrix, 
    (frame.shape[1], frame.shape[0]),
    borderValue=(0, 0, 0)  # 黑色填充
)
```

### 5. 比例尺同步旋轉處理

#### 重要修改點：
- **比例尺圖片旋轉**：在計算比例尺時，對應的比例尺圖片也需要套用相同角度的旋轉
- **一致性保證**：確保影片和比例尺圖片使用相同的旋轉參數
- **計算精度**：旋轉後的比例尺計算仍需保持原有精度

#### 比例尺處理邏輯：
```python
# 在 lift_travel_detection.py 中的比例尺處理部分
for root, folder, files in os.walk(os.path.join(DATA_FOLDER, 'lifts', 'scale_images')):
    for file in files:
        video_name = "-".join(file.split(sep="-")[:-1]) + ".mp4"
        image = cv2.imread(os.path.join(root, file))
        
        # 檢查是否需要旋轉比例尺圖片
        if video_name in rotation_config:
            rotation_angle = rotation_config[video_name]
            image = rotate_frame(image, rotation_angle)
        
        # 繼續原有的比例尺計算邏輯...
```

### 6. 主程式整合修改

#### 修改點：
1. **匯入旋轉配置**：`from rotation_config import rotation_config`
2. **旋轉處理整合**：在影像處理前檢查並套用旋轉
3. **比例尺同步**：確保比例尺圖片也套用相同旋轉
4. **輸出處理**：確保 inspection 影片使用旋轉後的影像

#### 整合邏輯：
```python
# 在 scan 函數中的影像處理前
def scan(video_path, file_name):
    # ... 原有程式碼 ...
    
    while ret:
        frame_idx = int(vidcap.get(cv2.CAP_PROP_POS_FRAMES))
        ret, frame = vidcap.read()
        
        # 檢查是否需要旋轉
        if file_name in rotation_config:
            rotation_angle = rotation_config[file_name]
            frame = rotate_frame(frame, rotation_angle)
        
        # 繼續原有的特徵點偵測邏輯...
```

## 🎨 視覺化追溯功能

### 預覽圖片規格：
- **檔名格式**：`rotation_<原影片檔名>.png`
- **儲存位置**：`lifts/rotations/`
- **內容**：並排顯示兩幀旋轉後的對比 (左側第一幀，右側第二幀)
- **標註**：包含檔名、旋轉角度等資訊

## 🔧 技術實作細節

### 依賴套件：
- **OpenCV** - 影像旋轉處理
- **NumPy** - 數值計算
- **隨機採樣** - 預覽幀選取

### 角度約定：
- **正值** = 逆時針旋轉
- **負值** = 順時針旋轉
- **單位** = 度 (degrees)

### 旋轉約束：
- **剛性變換**：不允許縮放，旋轉矩陣縮放因子固定為 1.0
- **尺寸保持**：輸出影像尺寸與輸入相同
- **填充方式**：空白區域使用黑色填充，不進行縮放適應

### 錯誤處理：
- 檔案不存在檢查
- 角度範圍驗證 (-360° 到 +360°)
- 目錄建立確認
- 旋轉配置檔案載入異常處理

## 📋 開發順序

1. ✅ **建立旋轉處理核心函數** (剛性變換，黑色填充)
2. ✅ **開發互動式設定工具** (含角度調整循環)
3. ✅ **實作預覽功能** (雙幀旋轉後並排顯示)
4. ✅ **實作角度調整機制** (預覽-確認-重新輸入循環)
5. ✅ **比例尺同步旋轉處理** (確保計算精度)
6. ✅ **整合主程式修改** (影片和比例尺一致旋轉)
7. ✅ **測試與驗證** (運動偵測精度改善驗證)

## 🧪 測試計畫

### 測試案例：
1. **正常旋轉** - 測試 ±15°, ±30°, ±45° 等常見角度
2. **邊界測試** - 測試 0°, ±90°, ±180° 等特殊角度
3. **剛性約束** - 驗證旋轉後影像無縮放變形
4. **比例尺一致性** - 確認影片與比例尺圖片同步旋轉
5. **互動機制** - 測試角度調整循環的各種使用情境
6. **錯誤處理** - 測試無效檔名、超範圍角度
7. **整合測試** - 驗證主程式運動偵測結果改善

### 驗證指標：
- **幾何精度**：旋轉後直線仍為直線，角度準確
- **偵測改善**：減少因角度偏差導致的運動誤判
- **比例尺精度**：旋轉後距離測量保持準確性
- **使用者體驗**：角度調整流程順暢，預覽清晰易懂

---

## 📝 實作注意事項

1. **旋轉中心**：使用影像幾何中心作為旋轉中心
2. **插值方法**：使用雙線性插值保持影像品質
3. **記憶體效率**：大影片檔案的逐幀處理最佳化
4. **配置管理**：rotation_config.py 需要版本控制和備份機制
5. **向後相容**：未設定旋轉的影片維持原有處理流程
