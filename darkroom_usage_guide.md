# 🌙 暗房時間區間忽略功能使用指南

## 📖 功能簡介

暗房時間區間忽略功能可以在影片分析過程中自動忽略指定的時間區間，這些區間通常是由於房間關燈導致畫面過暗，目前的演算法無法正確處理的部分。

在設定的暗房時間區間內：
- ✅ **所有運動偵測結果都會被忽略**（設為 0）
- ✅ **顯示狀態為 "darkroom (ignored)"**，文字為灰色
- ✅ **不會累積到總移動距離中**
- ✅ **類似於 camera pan 的處理邏輯**

## 🚀 使用流程

### 1. 啟動暗房區間設定工具

```bash
# 確保在虛擬環境中
python src/darkroom_setup.py
```

### 2. 互動式設定流程

#### 步驟 1：輸入影片檔名
- **輸入檔名**：可以只輸入主檔名，系統會自動加上 `.mp4`
- **範例**：輸入 `28` 等同於 `28.mp4`

```
請輸入要設定暗房區間的影片檔名 (直接按 Enter 結束): 28
✅ 找到影片: 28.mp4
```

#### 步驟 2：設定時間區間
- **時間格式**：MM:SS (分:秒)
- **支援多個區間**：每個影片可設定多個暗房時間區間

```
📅 輸入時間區間:
  開始時間 (MM:SS): 05:27
  結束時間 (MM:SS): 12:11
  ✅ 時間區間: 05:27 ~ 12:11 (持續 06:44)
  確認此時間區間？ [y/n]: y
  ✅ 已加入區間 1: 05:27 ~ 12:11
```

#### 步驟 3：新增更多區間（可選）
- 對於有多個暗房區間的影片（如 30.mp4），可以繼續新增
- 開始時間留空則結束該影片的設定

```
📅 輸入時間區間:
  開始時間 (MM:SS): 05:31
  結束時間 (MM:SS): 12:40
  ✅ 已加入區間 2: 05:31 ~ 12:40

📅 輸入時間區間:
  開始時間 (MM:SS): [直接按 Enter 結束]
```

#### 步驟 4：重複設定其他影片
- 繼續設定其他需要暗房區間的影片
- 直接按 Enter 結束整個設定流程

### 3. 自動產生配置檔案

設定完成後，系統會自動產生 `src/darkroom_intervals.py` 配置檔案。

## 📁 產生的檔案

### 暗房配置檔案：`src/darkroom_intervals.py`
```python
darkroom_intervals = {
    '28.mp4': [('05:27', '12:11')],
    '29.mp4': [('04:19', '10:55')],
    '30.mp4': [('02:56', '04:50'), ('05:31', '12:40')],
    '31-1.mp4': [('02:45', '08:54')],
    '37.mp4': [('03:56', '05:08')],
}
```

## 🔬 運行主程式

設定完成後，正常執行主程式：

```bash
python src/lift_travel_detection.py
```

程式會自動：
1. **讀取暗房配置**：載入 `darkroom_intervals.py`
2. **時間檢查**：對每一幀檢查是否在暗房區間內
3. **忽略運動**：暗房區間內的運動距離設為 0
4. **視覺標示**：在檢查影片中顯示 "darkroom (ignored)"

## 🎨 視覺化效果

### 在 inspection 影片中的顯示：
- **正常區間**：`15.5 sec  travel: 0.00123 mm` (綠色/紅色文字)
- **相機平移**：`20.3 sec  camera pan` (黃色文字)
- **暗房區間**：`08:30 sec  darkroom (ignored)` (灰色文字)

### 狀態優先級：
1. 🌙 **暗房區間** > 📹 **相機平移** > 📏 **正常運動**

## ⚙️ 功能特點

### 1. **精確時間控制**
- 支援 MM:SS 格式的精確時間設定
- 自動驗證時間區間的合理性
- 支援每個影片多個獨立時間區間

### 2. **與現有功能整合**
- 完全相容旋轉校正功能
- 完全相容 ROI 自訂功能
- 不影響其他正常的運動偵測邏輯

### 3. **使用者友好**
- 檔名自動補完（不需輸入 .mp4）
- 直觀的時間輸入格式
- 即時驗證和確認機制

### 4. **配置管理**
- 支援修改現有設定
- 支援新增額外區間
- 自動產生標準化配置檔案

## 📋 範例設定

根據您提供的資料：

```
28.mp4  → 暗房區間: 05:27~12:11
29.mp4  → 暗房區間: 04:19~10:55  
30.mp4  → 暗房區間: 02:56~04:50, 05:31~12:40 (兩個區間)
31-1.mp4 → 暗房區間: 02:45~08:54
37.mp4  → 暗房區間: 03:56~05:08
```

### 完整設定範例：
```bash
# 啟動設定工具
python src/darkroom_setup.py

# 設定 28.mp4
請輸入要設定暗房區間的影片檔名: 28
開始時間 (MM:SS): 05:27
結束時間 (MM:SS): 12:11

# 設定 30.mp4 (多個區間)
請輸入要設定暗房區間的影片檔名: 30
開始時間 (MM:SS): 02:56
結束時間 (MM:SS): 04:50
開始時間 (MM:SS): 05:31  
結束時間 (MM:SS): 12:40
開始時間 (MM:SS): [Enter 結束]

# 繼續設定其他影片...
```

## 🧪 建議使用情境

### 適用情況：
- ✅ 房間關燈導致畫面過暗
- ✅ 演算法無法正確處理的畫面
- ✅ 需要暫時忽略某些時間段的運動
- ✅ 特殊實驗條件下的畫面

### 不需要使用：
- ❌ 畫面品質良好的時間段
- ❌ 已經可以正確偵測運動的區間
- ❌ 只是暫時的亮度變化

## 📝 注意事項

1. **時間精度**：設定的時間區間會精確到秒
2. **區間重疊**：避免設定重疊的時間區間
3. **配置備份**：重要設定建議備份 `darkroom_intervals.py`
4. **結果驗證**：檢查 inspection 影片確認暗房區間正確標示
5. **與其他功能**：可與旋轉校正、ROI 設定同時使用

## 🔧 疑難排解

### 問題：找不到影片檔案
- **解決**：確認檔名正確，影片在 `lifts/data/` 目錄中

### 問題：時間格式錯誤
- **解決**：使用 MM:SS 格式，例如 `05:27` 或 `12:11`

### 問題：時間區間無效
- **解決**：確保結束時間大於開始時間

### 問題：設定後沒有效果
- **解決**：檢查 `darkroom_intervals.py` 是否正確產生

### 問題：程式執行錯誤
- **解決**：確認虛擬環境已啟用，所有依賴套件已安裝

---

## 🎯 完整工作流範例

```bash
# 1. 設定暗房區間
python src/darkroom_setup.py

# 2. (可選) 設定影片旋轉
python src/rotation_setup.py  

# 3. 執行主程式分析
python src/lift_travel_detection.py

# 4. 檢查結果
# - inspection 影片會顯示 "darkroom (ignored)" 
# - CSV 結果中暗房區間的運動距離為 0
```

暗房區間忽略功能將有效提升分析結果的準確性，避免演算法在不適當的畫面條件下產生錯誤判斷！🎉
