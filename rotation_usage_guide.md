# 🔄 影片旋轉校正功能使用指南

## 📖 功能簡介

影片旋轉校正功能可解決攝影機角度偏差導致的運動偵測誤判問題。當攝影機的垂直方向與顯微鏡移動方向夾角較大時，程式可能將正常的載台垂直運動誤判為水平移動而被忽略。

## 🚀 使用流程

### 1. 啟動旋轉設定工具

```bash
# 確保在虛擬環境中
python src/rotation_setup.py
```

### 2. 互動式設定流程

#### 步驟 1：輸入影片檔名
- **輸入檔名**：可以只輸入主檔名，系統會自動加上 `.mp4`
- **範例**：輸入 `1` 等同於 `1.mp4`

```
請輸入要旋轉的影片檔名 (直接按 Enter 結束): 1
✅ 找到影片: 1.mp4
```

#### 步驟 2：設定旋轉角度
- **角度約定**：正值 = 逆時針，負值 = 順時針
- **範圍**：-360° 到 +360°

```
請輸入逆時針旋轉角度 (度): 15
```

#### 步驟 3：預覽效果
- 系統會顯示並排預覽視窗
- 左側：第一幀旋轉後影像
- 右側：第二幀旋轉後影像
- 從 `config.py` 指定的時間範圍內隨機選取

#### 步驟 4：確認或調整
```
預覽效果是否滿意？
  [y] 確認使用此角度
  [r] 重新輸入角度
  [c] 取消此影片設定
請選擇 (y/r/c): 
```

- **[y]**：確認並儲存此角度設定
- **[r]**：重新輸入角度，再次預覽
- **[c]**：跳過此影片，不設定旋轉

#### 步驟 5：重複設定
- 繼續設定其他需要旋轉的影片
- 直接按 Enter 結束設定

### 3. 自動產生配置檔案

設定完成後，系統會自動：
- 產生 `src/rotation_config.py` 配置檔案
- 儲存預覽圖片至 `lifts/rotations/` 目錄

## 📁 產生的檔案

### 1. 旋轉配置檔案：`src/rotation_config.py`
```python
rotation_config = {
    '1.mp4': 15,
    '5-2.mp4': -10,
    '12.mp4': 20,
}
```

### 2. 預覽圖片：`lifts/rotations/`
- **檔名格式**：`rotation_<影片檔名>.png`
- **內容**：並排顯示旋轉後的對比圖片
- **用途**：供後續追溯和確認

## 🔬 運行主程式

設定完成後，正常執行主程式：

```bash
python src/lift_travel_detection.py
```

程式會自動：
1. **讀取旋轉配置**：載入 `rotation_config.py`
2. **同步旋轉處理**：
   - 影片幀旋轉：分析前先旋轉每一幀
   - 比例尺旋轉：比例尺圖片同步旋轉，確保測量精度
3. **生成結果**：
   - `lifts/inspection/`：使用旋轉後影像組成的檢查影片
   - `lifts/result/`：運動分析 CSV 結果

## ⚙️ 功能特點

### 1. **剛性旋轉**
- 不進行縮放，維持影像品質
- 空白區域黑色填充
- 保持原始影像尺寸

### 2. **比例尺同步**
- 影片和比例尺圖片使用相同旋轉角度
- 確保距離測量精度不受影響

### 3. **與 ROI 功能整合**
- 支援 `config.py` 中的自訂 ROI 設定
- 旋轉後可重新調整 ROI 範圍

### 4. **使用者友好**
- 檔名自動補完（不需輸入 .mp4）
- 即時預覽效果
- 支援反覆調整角度

## 🧪 建議使用情境

### 適用情況：
- ✅ 攝影機角度明顯偏斜
- ✅ 垂直運動被誤判為水平移動
- ✅ 需要精確的運動軌跡分析

### 不需要使用：
- ❌ 攝影機角度已經很正
- ❌ 運動偵測結果已經滿意
- ❌ 只是輕微的角度偏差

## 📝 注意事項

1. **備份重要資料**：設定前建議備份原始影片
2. **預覽確認**：務必仔細檢查預覽效果再確認
3. **角度適中**：避免過大的旋轉角度（建議 ±45° 以內）
4. **ROI 重設**：旋轉後可能需要重新調整 ROI 範圍
5. **比例尺檢查**：確認旋轉後比例尺計算仍然準確

## 🔧 疑難排解

### 問題：找不到影片檔案
- **解決**：確認檔名正確，影片在 `lifts/data/` 目錄中

### 問題：預覽視窗沒有顯示
- **解決**：檢查是否有安裝 OpenCV 的 GUI 支援

### 問題：旋轉後效果不理想
- **解決**：使用 [r] 選項重新調整角度

### 問題：程式執行錯誤
- **解決**：確認虛擬環境已啟用，所有依賴套件已安裝

---

## 🎯 使用範例

```bash
# 1. 啟動設定工具
python src/rotation_setup.py

# 2. 設定影片旋轉（範例對話）
請輸入要旋轉的影片檔名: 1
請輸入逆時針旋轉角度 (度): 15
[預覽視窗顯示]
請選擇 (y/r/c): y
已設定 1.mp4 旋轉 15 度

請輸入要旋轉的影片檔名: 
設定完成！

# 3. 執行主程式
python src/lift_travel_detection.py
```

旋轉校正功能將大幅提升運動偵測的準確性！🎉
